<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スタバレシート栄養照合</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; text-align: center; }
    #result, #nutrition { margin-top: 1em; white-space: pre-wrap; text-align: left; }
    #progress { margin-top: 1em; color: gray; }
    #log { margin-top: 1em; color: darkgreen; font-size: 0.9em; text-align: left; white-space: pre-wrap; display: none; }
    #adminToggle { position: fixed; top: 10px; right: 10px; }
  </style>
</head>
<body>
  <h1>レシート画像で栄養素表示</h1>
  <input type="file" id="imageInput" accept="image/*">
  <label id="adminToggle">
    <input type="checkbox" id="debugMode"> テストモード
  </label>
  <div id="progress"></div>
  <div id="result"></div>
  <div id="nutrition"></div>
  <div id="log"></div>

  <script>
    let debug = false;
    const password = "adminpass"; // 任意に変更可

    document.getElementById('debugMode').addEventListener('change', function () {
      if (this.checked) {
        const input = prompt("パスワードを入力してください:");
        if (input === password) {
          debug = true;
          document.getElementById('log').style.display = "block";
        } else {
          alert("パスワードが違います");
          this.checked = false;
        }
      } else {
        debug = false;
        document.getElementById('log').style.display = "none";
      }
    });

    function log(msg) {
      if (debug) {
        document.getElementById("log").innerText += "\n" + msg;
      }
    }

    async function fetchNutritionData() {
      const res = await fetch("nutrition.json");
      return res.json();
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();

      document.getElementById('progress').innerText = "画像解析中...";
      document.getElementById('result').innerText = "";
      document.getElementById('nutrition').innerText = "";
      document.getElementById('log').innerText = debug ? "[LOG] ファイル選択済み: " + file.name : "";

      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];
        log("[LOG] base64変換完了、APIリクエスト開始...");

        const response = await fetch("https://your-render-backend.onrender.com/api/vision", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: base64 })
        });

        const data = await response.json();
        log("[LOG] APIレスポンス: " + JSON.stringify(data));

        if (!data || !data.result) {
          document.getElementById('result').innerText = "⚠️ 認識失敗";
          return;
        }

        document.getElementById('result').innerText = JSON.stringify(data.result, null, 2);
        const nutritionList = await fetchNutritionData();
        const match = nutritionList.find(item =>
          data.result.name.includes(item.keyword) &&
          data.result.size === item.size &&
          data.result.price === item.price
        );

        if (match) {
          document.getElementById('nutrition').innerHTML = `
            <p>🍹 商品名: ${match.name}（${match.size}）</p>
            <p>🔥 カロリー: ${match.calories_kcal} kcal</p>
            <p>💪 たんぱく質: ${match.protein_g} g</p>
            <p>🧈 脂質: ${match.fat_g} g</p>
            <p>🍚 炭水化物: ${match.carbs_g} g</p>
          `;
        } else {
          document.getElementById('nutrition').innerText = "⚠️ 栄養成分データが見つかりませんでした。";
        }

        document.getElementById('progress').innerText = "";
      };

      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
