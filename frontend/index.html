<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スタバレシート栄養照合</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; text-align: center; }
    #result, #nutrition { margin-top: 1em; white-space: pre-wrap; text-align: left; }
    #progress { margin-top: 1em; color: gray; }
    #log { margin-top: 1em; color: darkgreen; font-size: 0.9em; text-align: left; white-space: pre-wrap; }
    #debugToggle { position: fixed; top: 10px; right: 10px; }
  </style>
</head>
<body>
  <h1>レシート画像で栄養素表示</h1>
  <input type="file" id="imageInput" accept="image/*">
  <label id="debugToggle">
    <input type="checkbox" id="testMode"> テストモード
  </label>
  <div id="progress"></div>
  <div id="result"></div>
  <div id="nutrition"></div>
  <div id="log"></div>

  <script>
    const log = (msg) => {
      if (window.testModeEnabled)
        document.getElementById('log').innerText += `[LOG] ${msg}\n`;
    };

    document.getElementById('testMode').addEventListener('change', async (e) => {
      if (e.target.checked) {
        const pw = prompt("テストモードのパスワードを入力してください:");
        if (pw === "testpass123") {
          window.testModeEnabled = true;
          log("✅ テストモード有効");
        } else {
          alert("❌ パスワードが違います");
          e.target.checked = false;
        }
      } else {
        window.testModeEnabled = false;
        document.getElementById('log').innerText = "";
      }
    });

    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('progress').innerText = "処理中...";
      document.getElementById('log').innerText = "";
      log("ファイル選択済み: " + file.name);

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];
        log("base64変換完了、APIリクエスト開始...");

        const response = await fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: base64 })
        });

        log("APIレスポンス受信中...");
        const resultText = await response.text();
        log("APIレスポンス受信完了: " + resultText);

        try {
          const parsed = JSON.parse(resultText);
          document.getElementById('result').innerText = JSON.stringify(parsed, null, 2);
          matchNutrition(parsed);
        } catch (err) {
          document.getElementById('nutrition').innerText = "⚠️ JSONの解析に失敗しました。";
          log("[ERROR] JSON.parse失敗: " + err.message);
        } finally {
          document.getElementById('progress').innerText = "";
        }
      };
      reader.readAsDataURL(file);
    });

    async function matchNutrition(item) {
      const res = await fetch("/nutrition.json");
      const data = await res.json();
      const matched = data.find(e =>
        e.name.includes(item.name.replace("ブラ", "")) &&
        e.size === item.size
      );
      if (matched) {
        document.getElementById('nutrition').innerHTML = `
          <p>🍹 商品名: ${matched.name}（${matched.size}）</p>
          <p>🔥 カロリー: ${matched.calories_kcal} kcal</p>
          <p>💪 たんぱく質: ${matched.protein_g} g</p>
          <p>🧈 脂質: ${matched.fat_g} g</p>
          <p>🍚 炭水化物: ${matched.carbs_g} g</p>
        `;
        log("栄養照合成功");
      } else {
        document.getElementById('nutrition').innerText = "⚠️ 栄養成分データが見つかりません。";
        log("該当商品なし: " + item.name);
      }
    }
  </script>
</body>
</html>
