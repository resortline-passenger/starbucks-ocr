<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ã‚¿ãƒãƒ¬ã‚·ãƒ¼ãƒˆæ „é¤Šç…§åˆ</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; text-align: center; }
    #result, #nutrition { margin-top: 1em; white-space: pre-wrap; text-align: left; }
    #progress { margin-top: 1em; color: gray; }
    #log { margin-top: 1em; color: darkgreen; font-size: 0.9em; text-align: left; white-space: pre-wrap; }
    #testModeToggle { margin-left: 0.5em; }
    .toggle-label { position: fixed; top: 10px; right: 10px; background: #eee; padding: 0.5em; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã§æ „é¤Šç´ è¡¨ç¤º</h1>

  <!-- âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒã‚§ãƒƒã‚¯ -->
  <label class="toggle-label">
    <input type="checkbox" id="testModeToggle"> ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
  </label>

  <input type="file" id="imageInput" accept="image/*">
  <div id="progress"></div>
  <div id="result"></div>
  <div id="nutrition"></div>
  <div id="log"></div>

  <script>
    let testMode = false;
    const TEST_PASSWORD = "test1234"; // æœ¬ç•ªã§ã¯ backend ã«ç§»è¡Œæ¨å¥¨

    document.getElementById('testModeToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        const input = prompt("ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (input === TEST_PASSWORD) {
          testMode = true;
          log("[MODE] ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹");
        } else {
          alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
          e.target.checked = false;
        }
      } else {
        testMode = false;
        log("[MODE] ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è§£é™¤");
      }
    });

    function log(message) {
      if (!testMode) return;
      const logEl = document.getElementById('log');
      logEl.innerText += `\n${message}`;
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('progress').innerText = "ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Šä¸­...";
      document.getElementById('log').innerText = "[LOG] ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿: " + file.name;

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const base64 = reader.result.split(',')[1];
          log("[LOG] base64å¤‰æ›å®Œäº†ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹...");

          const response = await fetch("/api/vision", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64 })
          });

          log("[LOG] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡ä¸­...");
          const data = await response.json();
          log("[LOG] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡å®Œäº†: " + JSON.stringify(data));

          const content = data.text;
          document.getElementById('result').innerText = content;

          try {
            const parsed = JSON.parse(content);
            matchNutrition(parsed);
          } catch (e) {
            document.getElementById('nutrition').innerText = "âš ï¸ JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            log("[ERROR] JSONè§£æå¤±æ•—: " + e.message);
          }
        } catch (error) {
          log("[ERROR] å‡¦ç†ä¸­ã«ä¾‹å¤–ãŒç™ºç”Ÿ: " + error.message);
        } finally {
          document.getElementById('progress').innerText = "";
        }
      };
      reader.readAsDataURL(file);
    });

    async function matchNutrition(item) {
      try {
        const res = await fetch('/nutrition.json');
        const nutritionData = await res.json();

        // é‡‘é¡ã«ã‚ˆã‚‹è£œåŠ©ä¸€è‡´
        const matched = nutritionData.find(entry =>
          entry.name.includes(item.name.replace(/ãƒ–ãƒ©/g, "")) && entry.size === item.size
        );

        if (matched) {
          document.getElementById('nutrition').innerHTML = `
            <p>ğŸ¹ å•†å“å: ${matched.name}ï¼ˆ${matched.size}ï¼‰</p>
            <p>ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼: ${matched.calories_kcal} kcal</p>
            <p>ğŸ’ª ãŸã‚“ã±ãè³ª: ${matched.protein_g} g</p>
            <p>ğŸ§ˆ è„‚è³ª: ${matched.fat_g} g</p>
            <p>ğŸš ç‚­æ°´åŒ–ç‰©: ${matched.carbs_g} g</p>
          `;
          log("[LOG] æ „é¤Šãƒ‡ãƒ¼ã‚¿ç…§åˆæˆåŠŸ");
        } else {
          document.getElementById('nutrition').innerText = "âš ï¸ æ „é¤Šæˆåˆ†ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
          log("[WARN] è©²å½“å•†å“ãŒnutrition.jsonã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
      } catch (err) {
        log("[ERROR] nutrition.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    }
  </script>
</body>
</html>
